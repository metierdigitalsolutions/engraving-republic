name: Publish Entraving Frontend

on:
  push:
    branches:
      - staging
      - main

jobs:
  Deploy-Frontend:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository with submodules
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: true  # Enable submodules during checkout
          fetch-depth: 1
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # Setup Node.js version
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Enable npm caching

      # Install dependencies (npm ci will use cache if available)
      - name: Install dependencies
        run: npm ci --prefer-offline

      # Build Landing-Page with environment-specific command
      - name: Build Landing-Page
        run: |
          if [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            npm run build:staging
          else
            npm run build:production
          fi

      - name: Test FTP Before Deploy
        run: |
          echo "Testing FTP connection to ${{ secrets.HOSTNAME }}:21..."
          
          # Simple connection test
          timeout 10 bash -c "echo > /dev/tcp/${{ secrets.HOSTNAME }}/21" && \
            echo "✅ Port 21 is open" || echo "❌ Port 21 is closed"
          
          # Test with ftp client
          sudo apt-get install -y ftp
          timeout 15 ftp -n ${{ secrets.HOSTNAME }} << EOF
          user ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_FRONT_USERNAME || secrets.MAIN_FRONT_USERNAME }} ${{ secrets.PASSWORD }}
          quit
          EOF
          
          if [ $? -eq 0 ]; then
            echo "✅ FTP connection successful"
          else
            echo "❌ FTP connection failed - Use SFTP instead"
          fi
          
      - name: Deploy with Timeout
        uses: SamKirkland/FTP-Deploy-Action@4.3.3
        with:
          server: ${{ secrets.HOSTNAME }}
          username: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_FRONT_USERNAME || secrets.MAIN_FRONT_USERNAME }}
          password: ${{ secrets.PASSWORD }}
          server-dir: /
          local-dir: ./dist/
          timeout: 300000  # 5 minutes
          log-level: verbose
          
      # # Deploy Build Output to Landing-Page Folder
      # - name: Deploy Landing-Page Build
      #   # uses: SamKirkland/FTP-Deploy-Action@4.3.3
      #   uses: sebastianpopp/ftp-action@v2.0.0
      #   with:
      #     host: ${{ secrets.HOSTNAME }}
      #     user: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_FRONT_USERNAME || secrets.MAIN_FRONT_USERNAME }}
      #     password: ${{ secrets.PASSWORD }}
      #     localDir: ./dist/
      #     remoteDir: /