name: Publish Entraving Frontend

on:
  push:
    branches:
      - staging
      - main

jobs:
  Deploy-Frontend:
    runs-on: ubuntu-latest

    steps:
      # Checkout repository with submodules
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          submodules: true  # Enable submodules during checkout
          fetch-depth: 1
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

      # Setup Node.js version
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'  # Enable npm caching

      # Install dependencies (npm ci will use cache if available)
      - name: Install dependencies
        run: npm ci --prefer-offline

      # Build Landing-Page with environment-specific command
      - name: Build Landing-Page
        run: |
          if [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            npm run build:staging
          else
            npm run build:production
          fi

      - name: Deploy via SFTP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: engravingrepublicng.com
          port: 65002
          username: ${{ secrets.STAGING_FRONT_USERNAME }}
          password: ${{ secrets.PASSWORD }}
          source: ./dist/
          target: public_html/

        # - name: Check if deployment succeeded
        # if: ${{ failure() }}
        # run: |
        #   echo "FTP deployment failed or timed out"
        #   echo "Try alternative methods:"
        #   echo "1. Use SFTP instead of FTP"
        #   echo "2. Deploy manually via SSH"
        #   echo "3. Contact hosting provider"
        #   exit 1
          
      # - name: Deploy via SFTP
      #   uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      #   with:
      #     server: ${{ secrets.HOSTNAME }}
      #     username: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_FRONT_USERNAME || secrets.MAIN_FRONT_USERNAME }}
      #     password: ${{ secrets.PASSWORD }}
      #     port: 22  # SFTP uses port 22
      #     local_path: './dist/*'
      #     remote_path: '/'
      #     args: '-o ConnectTimeout=30 -o ServerAliveInterval=60'

      # # Deploy Build Output to Landing-Page Folder
      # - name: Deploy Landing-Page Build
      #   # uses: SamKirkland/FTP-Deploy-Action@4.3.3
      #   uses: sebastianpopp/ftp-action@v2.0.0
      #   with:
      #     host: ${{ secrets.HOSTNAME }}
      #     user: ${{ github.ref == 'refs/heads/staging' && secrets.STAGING_FRONT_USERNAME || secrets.MAIN_FRONT_USERNAME }}
      #     password: ${{ secrets.PASSWORD }}
      #     localDir: ./dist/
      #     remoteDir: /